# gdpr-retinaface

- проект автоматически находит и размывает лица в видео и фотографиях
- работает на ноутбуках Windows
- нет необходимости в графической карте
- полностью open-source
- основан на open-source проекте https://github.com/biubug6/Pytorch_Retinaface
- безопасен, не требует выхода в интеренет, не собирает и не распространяет ваши данные

# подготовка системы
1. скачайте и установите Python версии 3.x (https://www.python.org/). Тестировалось на версии 3.8.6

**Важно** - при установке поставьте галочку добавить Python в переменную пути (Path)

2. установите pythorch (https://pytorch.org/get-started/locally/)

2.1 Если в вашем компьютере нет графической карты Nvidia, перейдите по ссылке и выберете Package - Pip, CUDA - None и скопируйте команду, например 
```
pip install torch==1.6.0+cpu torchvision==0.7.0+cpu -f https://download.pytorch.org/whl/torch_stable.html
```
2.2 Если у вас есть современная графическая карта Nvidia, выберете Package - Pip, CUDA - 10.2 и скопируйте команду, например 
```
pip install torch===1.6.0 torchvision===0.7.0 -f https://download.pytorch.org/whl/torch_stable.html
```
2.2 откройте в Windows командную строку (в поиске наберите cmd), вставте команду по установке pythorch и нажмите Enter. Начнется установка и займет какое-то время, в зависимости от скорости вашего интеренета.

3. последний шаг - установка кодека для видео, для этого проекта используется кодек ffmpeg (https://ffmpeg.org/download.html).
Подробная инструкция по установке тут: https://ip-calculator.ru/blog/ask/kak-ustanovit-ffmpeg-na-windows/

Главное, выполните эти шаги:

3.1 На сайте ffmpeg, выберите Windows, скачайте файл установки, например отсюда:
https://github.com/BtbN/FFmpeg-Builds/releases/download/autobuild-2020-10-22-12-33/ffmpeg-N-99692-gde59826703-win64-gpl.zip

3.2 Скопируйте папку на диск D: или C:, распакуйте и переименуйте папку в ffpmeg (или другое короткое имя)

3.3 Добавьте путь к папке (например C:\ffmpeg\bin\) в переменные системы

3.4 откройте командную строку и выполните команду ffpmeg, чтобы проверить что ffpmeg запускается


# подготовка проекта

вы можете либо полностью скачать этот проект, либо собрать его за 4 шага ниже (если хотите проверить как он был собран)

## подготовка - простой вариант

1. создайте папку в которой будут находится файлы проекта, например, папку **gdpr** на диске d:
2. скачайте этот проект (он отличается от основного только 2мя файлами и добавлеными моделами - смотрите ниже детали)
(нажмите зеленую кнопку ``code`` - скачать zip)
сохраните в вашу новую папку и распакуйте. структура папок будет выглядить так
```d-
|--gdpr
|   |--gdpr-retinaface-main
```
готово! можно переходить к запуску

## подготовка - собираем проект сами

1. создайте папку в которой будут находится файлы проекта, например, папку **gdpr** на диске d:
2. скачайте основной open-source проект https://github.com/biubug6/Pytorch_Retinaface (нажмите зеленую кнопку ``code`` - скачать zip)
сохраните в вашу новую папку и распакуйте. структура папок будет выглядить так

```d-
|--gdpr
|   |--Pytorch_Retinaface-master
```
3. как часть настройки этого проекта вам нужно скачать готовые модели по детектированию лиц (https://github.com/biubug6/Pytorch_Retinaface#training)

сама ссылка тут https://drive.google.com/open?id=1oZRSG0ZegbVkVwUd8wUIQx8W7yfZ_ki1

3.1 скачайте модели и поместите в папку **Pytorch_Retinaface-master/weights** (папку weights надо перед этим создать)


4. добавьте в основную папку новый файл из этого проекта **blur_face.py** (https://github.com/kumarbalavi/gdpr-retinaface/blob/main/blur_face.py), который позволит проще запускать проект и файл **rerquirement.txt** (https://github.com/kumarbalavi/gdpr-retinaface/blob/main/requirements.txt) со списком модулей Python для установки

# запуск проекта
1. откройте командную строку Windows
2. перейдите на диск d: и в папку с проектом (gdpr-retinaface-main если скачивали этот проект, Pytorch_Retinaface-master если собирали сами)
```
d:
cd d:/gdpr/gdpr-retinaface-main
```

3. установите необходимые модули Python выполнив следующую команду
```
pip install -r requirements.txt
```

4. скопируйте ваш видео файл в папку curve
5. запустите проект выполнив следующую команду
```
python blur_face.py --input_path curve/video_test.mp4 --output_path curve/video_test_out.mp4 --is_video True --keep_time 10
```
6. выполнение может занять несколько минут, после этого посмотрите свой файл video_test_out.mp4


# параметры запуска
после того как все настройки и установки выполнены, вам, чтобы обработать видео, будет необходимо только выполнять команду из шага **5** (запуск проекта) указав путь к новому файлу.
Если вас не устраивает результат, вы можете изменить параметры запуска
- **--input_path** путь к исходному файлу
- **--output_path** путь к файлу после обработки
- **--is_video** указать True для видео, или не указывать для фото
- **--cpu** ставьте этот флаг в False, если хотите запускать на видео карточке
- **--size** параметр силы размытия, увеличте если хотите большее размытие (по определению 8)
- **--extend** если хотите увеличить размер окна размывки (чтобы скрыть волосы и элементы одежды) поставте тут значение на сколько в процентах увеличть размер окна
- **--confidence_threshold** если не все лица детектированы, уменьшите этот параметр, по определению стоит 0.01, попробуйе с 0.007
- **--keep_time** система может пропускать лица на некоторых кадрах, этот параметр позволяет размывать места, где система нашла лица не только в текущим кадре но и на несколько кадров назад. увеличте этот параметр, чтобы уменьшить пропуски.

пример

```
python blur_face.py --input_path curve/test.mp4 --output_path curve/test_out.mp4 --is_video True --confidence_threshold 0.007 --size 10 --extend 0.3 --keep_time 25
```

больше параметров и их описания смотрите в самом файле **blur_face.py**

чтобы обработка видео проходила быстрее - используйте компьютер с графической картой Nvidia и ставьте параметр --cpu False

если возникли вопросы - пишите
